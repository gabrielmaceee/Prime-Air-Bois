---
title: "AFDM_communes"
author: "Gabriel Macé"
date: "2024-06-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning= FALSE)
```
# Qu'est ce que l'on veut voir exactement avec l'ACP ? Les types de communes ou les variables explicatives du nombre de dossiers ?


```{r, include=FALSE}
library(readxl)
library(writexl)
library(stringr)
library(tidyr)
library(sf)
library(dplyr)
library(stats)
library(ggplot2)
library(stats)
library(factoextra)
library(FactoMineR)
library(corrplot)

data <- read_excel("../data/3_Resultat/data_questionnaire_complet.xlsx")[-1]
data <- data[!data$insee_com %in% c("38453","38278", "38526", "38194", "38118", "38013", "38248", "38450", "38236", "38412", "38405", "38442", "38446", "38378"),]
comm <- read.csv("../data/siddt.csv", sep = ";", skip = 2)[-c(124:130),c(1,2, 3,4,6)]
comm2 <- read.csv("../data/siddt2.csv", sep = ";", skip = 2)[-c(124:130),c(1, 3:5)]
logement = read.csv("../data/logements_2020.csv", sep =";", skip= 2)[-c(124:130),c(1,3)]
objectifs_communes <- read_excel("../data/objectifs_communes_2022_2023.xlsx")[1:123,1:4]
oc <- read_excel("../data/objectifs_communes_2022_2023.xlsx")[124:239,c(2,4)]
objectifs_communes <- left_join(objectifs_communes, oc, by = "id_comm")
objectifs_communes$id_comm = as.character(objectifs_communes$id_comm)
objectifs_communes = objectifs_communes[,c(1,2,4,5)]
names(objectifs_communes)= c("Territoire","insee_com", "objectifs_2022", "changement_2023")
objectifs_communes$changement_2023 = abs(objectifs_communes$changement_2023)
objectifs_communes[is.na(objectifs_communes$changement_2023), "changement_2023"] <- 0
revenus_communes <- read_xlsx("../data/revenu_communes_insee.xlsx", skip = 5, col_names = TRUE)
revenus_communes <- revenus_communes[revenus_communes$CODGEO %in% data$insee_com,]
revenus_communes = revenus_communes[, c(1, 3:5)]
names(revenus_communes) = c("insee_com", "nb_ménages_fiscaux", "nb_personnes_menages_fiscaux", "mediane_niveau_vie")
```


```{r}
count <- data %>%
  group_by(insee_com) %>%
  count()
fo <- data[data$Type.Ancien.appareil != "Foyer ouvert",] %>%
  group_by(insee_com) %>%
  count()
buche <- data[data$Type.combustible.nouveau.materiel == "Bûche",] %>%
  group_by(insee_com) %>%
  count()
maj <- data[data$majoration == "M",] %>% group_by(insee_com) %>% count()
names(comm) <- c("communes.depcom","commune", "superficie_foret", "taux_forets", "évolution_nb_logements")
data_afdm = left_join(count, comm, by = join_by("insee_com" == "communes.depcom"))
names(comm2) <- c("communes.depcom", "Densité_pop", "Part_résidences_principales_loc", "part_maisons")
data_afdm <- data_afdm %>% left_join(comm2, by = join_by("insee_com" == "communes.depcom"))
names(logement) = c("insee_com", "nb_maisons_rp_2020")
data_afdm <- data_afdm %>% left_join(logement, by = "insee_com")
data_afdm <- data_afdm %>% left_join(objectifs_communes, by = "insee_com")
data_afdm <- data_afdm %>% left_join(revenus_communes, by = "insee_com")
data_afdm <- na.omit(data_afdm)
data_afdm[, "taux_dossiers_habitant"] = data_afdm$n / as.numeric(data_afdm$nb_personnes_menages_fiscaux)
data_afdm[, "taux_dossiers_menages"] = data_afdm$n / as.numeric(data_afdm$nb_ménages_fiscaux)
data_afdm[, "taux_dossiers_maisons"] = data_afdm$n / as.numeric(data_afdm$nb_maisons_rp_2020)
data_afdm[, "taux_foyers_ouverts"] =  1- (fo[-c(60, 125), ]$n / count[-c(60,125),]$n)
data_afdm[, "taux_buches_nouveau_mat"] = buche[-c(60,125),]$n / count[-c(60,125),]$n
data_afdm[, "taux_majoration"] = maj[-c(60,125),]$n / count[-c(60,125),]$n
data_afdm[, "taux_changement"] = data_afdm$changement_2023 / data_afdm$objectifs_2022
data_afdm[, "objectifs_2022_par_maison"] = data_afdm$objectifs_2022 / data_afdm$nb_maisons_rp_2020
data_afdm <- na.omit(data_afdm)
```


```{r}
for(i in setdiff(names(data_afdm), c("insee_com", "commune", "Territoire"))) data_afdm[,i] <- as.numeric(data_afdm %>% pull(i))
```

```{r}
inclure <- c("dossier_pop", "superficie_foret", "taux_forets", "évolution_nb_logements", "Densité.de.population", "Part.des.résidences.principales.en.location", "part_maisons",  "objectifs_2022", "changement_2023"
             )
exclure <- setdiff(names(data_afdm),  c("insee_com", "commune", "Territoire", "nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022"))

for(c in exclure){
  data_afdm[,c] <- as.numeric(data_afdm %>% pull(c))
}
inclure <- c(inclure, "Territoire")
```

```{r}
res.pca <- PCA(data_afdm[,setdiff(names(data_afdm),c(
  # variables "doublons :
  "nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022", "évolution_nb_logements"
  # "mediane_niveau_vie"?
  # "Densité_pop" corrélée nb_maisons_rp_2020
# variable qui n'explique pas le taux de dossiers par habitant: R² < 0.1, |corr| <0.25
# pb des taux par communes : peu de dossiers: taux hyper volatile
   ,"taux_foyers_ouverts","taux_buches_nouveau_mat"#, "taux_majoration"
#, "objectifs_2022_par_maison"
                                          ))], quali.sup = c("Territoire","insee_com", "commune"), scale.unit = TRUE)
# médiane niveau de vie va avec le taux de majoration
```


```{r}
eig.val <- get_eigenvalue(res.pca)
head(eig.val)
```


```{r}
#row.names(res.pca$ind$coord) <- na.omit(data_afdm)$commune
fviz_pca_ind(res.pca, habillage = "Territoire", palette = c("green","red", "blue"))
```
sans le na : plateau des pr : 77, Chamrousse : 122, Sarcenas : 97
```{r, include=FALSE}
fviz_eig(res.pca, addlabels = TRUE, ylim = c(0, 50))
```


```{r}
var <- get_pca_var(res.pca)
var

head(var$coord)# Coordonnées
head(var$cos2) # Cos2 : qualité de répresentation
head(var$contrib) # Contributions aux composantes principales
```
```{r}
hc <- hclust(dist(res.pca.ga$ind$coord))
plot(hc)
```

```{r}
# Créez une variable de regroupement en utilisant kmeans
set.seed(23)
res.km <- kmeans(res.pca$ind$coord, centers = 5, nstart = 25)# Créez 3 groupes de variables (centers = 3)
grp <- as.factor(res.km$cluster)
# Colorer les variables par groupes
fviz_pca_ind(res.pca, col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"), legend.title = "Cluster",addEllipses = FALSE) # colorer en fonction des clusters
```
36 : Grenoble, semble bien à l'écart
122 : Chamrousse :  encore plus
77 : Pl des p r
97 : Sarcenas
29 : Le Haut Brédas
```{r}
### Biplot : individus et variables

fviz_pca_biplot(res.pca, col.var = "black",col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"))


fviz_pca_biplot (res.pca, col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"), addEllipses = TRUE, label = "var", col.var = "black", repel = TRUE, legend.title = "Distance")
# + ellipses et couleur
```

```{r}
# Créez une variable de regroupement en utilisant kmeans
set.seed(23)
res.km <- kmeans(var$coord, centers = 4, nstart = 25)# Créez 3 groupes de variables (centers = 3)
grp <- as.factor(res.km$cluster)
# Colorer les variables par groupes
fviz_pca_var(res.pca, col.var = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green"), legend.title = "Cluster") # colorer en fonction des clusters
```

```{r}
library(Factoshiny)
PCAshiny(data_afdm[,setdiff(names(data_afdm),c(
  "nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022", "évolution_nb_logements"
   ,"taux_foyers_ouverts","taux_buches_nouveau_mat"))]) 
```

```{r}
PCAshiny(res.pca)
```

# ACP par territoire

```{r}
res.pca.v <- PCA(data_afdm[data_afdm$Territoire == "CA2017 du Pays Voironnais",setdiff(names(data_afdm),c("insee_com","Territoire","nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022","taux_foyers_ouverts","taux_buches_nouveau_mat", "évolution_nb_logements"#, "taux_majoration"#, "objectifs_2022_par_maison"
                                                                                                          ))], quali.sup = c("commune"), scale.unit = TRUE)

res.pca.gv <- PCA(data_afdm[data_afdm$Territoire == "CC2017 le Grésivaudan",setdiff(names(data_afdm),c("insee_com","Territoire","nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022","taux_foyers_ouverts","taux_buches_nouveau_mat", "évolution_nb_logements"#, "taux_majoration"#, "objectifs_2022_par_maison"
                                                                                                       ))], quali.sup = c("commune"), scale.unit = TRUE)

res.pca.ga <- PCA(data_afdm[data_afdm$Territoire == "CU2017 Métropole Grenoble-Alpes-Métropole",setdiff(names(data_afdm),c("insee_com","Territoire","nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022","taux_foyers_ouverts","taux_buches_nouveau_mat", "évolution_nb_logements"#, "taux_majoration"#, "objectifs_2022_par_maison"
                                                                                                                           ))], quali.sup = c("commune"), scale.unit = TRUE)
```

```{r}
head(get_eigenvalue(res.pca.v))
head(get_eigenvalue(res.pca.gv))
head(get_eigenvalue(res.pca.ga))
```




```{r}
fviz_pca_var(res.pca.v, col.var = "black")
fviz_pca_var(res.pca.gv, col.var = "black")
fviz_pca_var(res.pca.ga, col.var = "black")
```


```{r}
var.v = get_pca_var(res.pca.v)
var.gv = get_pca_var(res.pca.gv)
var.ga = get_pca_var(res.pca.ga)
corrplot(var.v$cos2, is.corr = FALSE) # qualité de représentations des variables
corrplot(var.gv$cos2, is.corr = FALSE)
corrplot(var.ga$cos2, is.corr = FALSE)
```

```{r}
corrplot(var.v$contrib, is.corr=FALSE) # contribution des variables aux différentes dimensions
corrplot(var.gv$contrib, is.corr=FALSE)
corrplot(var.ga$contrib, is.corr=FALSE)
```

## Contribution des communes aux trois premières dimensions :

```{r}
fviz_pca_contrib(res.pca.v, choice = "ind", axes = 1)
fviz_pca_contrib(res.pca.v, choice = "ind", axes = 2)
fviz_pca_contrib(res.pca.v, choice = "ind", axes = 3)

fviz_pca_contrib(res.pca.gv, choice = "ind", axes = 1)
fviz_pca_contrib(res.pca.gv, choice = "ind", axes = 2)
fviz_pca_contrib(res.pca.gv, choice = "ind", axes = 3)

fviz_pca_contrib(res.pca.ga, choice = "ind", axes = 1)
fviz_pca_contrib(res.pca.ga, choice = "ind", axes = 2)
fviz_pca_contrib(res.pca.ga, choice = "ind", axes = 3)
```

### Voironnais : 
Dim 1 = Voiron
Dim 2 = Réaumont
Dim 3 = La Sure en Chartreuse

### Grésivaudan : 
Dim 1 = Chamrousse
Dim 2 = Plateau des Petites Roches et Chamrousse
Dim 3 = Plateau des Petites Roches

### Grenoble Alpes Métropole : 
Dim 1 = Grenoble
Dim 2 = Séchilienne
Dim 3 = Sarcenas


# Nb de cluster optimal et identifier des outliers

```{r}
row.names(res.pca.v$ind$coord) <- na.omit(data_afdm[data_afdm$Territoire == "CA2017 du Pays Voironnais",])$insee_com
row.names(res.pca.gv$ind$coord) <- na.omit(data_afdm[data_afdm$Territoire == "CC2017 le Grésivaudan",])$insee_com
row.names(res.pca.ga$ind$coord) <- na.omit(data_afdm[data_afdm$Territoire == "CU2017 Métropole Grenoble-Alpes-Métropole",])$insee_com
```

```{r}
hc <- hclust(dist(res.pca.v$ind$coord))
plot(hc)
rect.hclust(hc,k=4)
hc <- hclust(dist(res.pca.gv$ind$coord))
plot(hc)
rect.hclust(hc,k=7)
hc <- hclust(dist(res.pca.ga$ind$coord))
plot(hc)
rect.hclust(hc,k=5)
```
4,7,5


```{r}
# Créez une variable de regroupement en utilisant kmeans
set.seed(23)
res.km <- kmeans(res.pca.v$ind$coord, centers = 4, nstart = 25)# Créez 3 groupes de variables (centers = 3)
grp <- as.factor(res.km$cluster)
# Colorer les variables par groupes
fviz_pca_ind(res.pca.v, col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"), legend.title = "Cluster",addEllipses = FALSE) # colorer en fonction des clusters
#fviz_pca_biplot(res.pca.v, col.var = "black",col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"))
print("Voironnais")
sapply(na.omit(data_afdm[data_afdm$Territoire == "CA2017 du Pays Voironnais",setdiff(names(data_afdm),c("insee_com","Territoire","nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022","taux_foyers_ouverts","taux_buches_nouveau_mat", "évolution_nb_logements","commune"))]),stat.comp,y=grp)

res.km <- kmeans(res.pca.gv$ind$coord, centers = 5, nstart = 25)# Créez 3 groupes de variables (centers = 3)
grp <- as.factor(res.km$cluster)
# Colorer les variables par groupes
fviz_pca_ind(res.pca.gv, col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"), legend.title = "Cluster",addEllipses = FALSE) # colorer en fonction des clusters
#fviz_pca_biplot(res.pca.gv, col.var = "black",col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"))
print("Grésivaudan")
sapply(na.omit(data_afdm[data_afdm$Territoire == "CC2017 le Grésivaudan",setdiff(names(data_afdm),c("insee_com","Territoire","nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022","taux_foyers_ouverts","taux_buches_nouveau_mat", "évolution_nb_logements","commune"))]),stat.comp,y=grp)

res.km <- kmeans(res.pca.ga$ind$coord, centers = 5, nstart = 25)# Créez 3 groupes de variables (centers = 3)
grp <- as.factor(res.km$cluster)
# Colorer les variables par groupes
fviz_pca_ind(res.pca.ga, col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"), legend.title = "Cluster",addEllipses = FALSE) # colorer en fonction des clusters
#fviz_pca_biplot(res.pca.ga, col.var = "black",col.ind = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green", "orange", "pink"))
print("Grenoble Alpes Métropole")
sapply(na.omit(data_afdm[data_afdm$Territoire == "CU2017 Métropole Grenoble-Alpes-Métropole", setdiff(names(data_afdm), c("insee_com","Territoire","nb_ménages_fiscaux", "n","nb_personnes_menages_fiscaux", "Part_résidences_principales_loc", "changement_2023", "taux_dossiers_menages",	"taux_dossiers_maisons", "objectifs_2022","taux_foyers_ouverts","taux_buches_nouveau_mat", "évolution_nb_logements","commune"))]),stat.comp,y=grp)
```

```{r}
# interprétation des variables / groupes
stat.comp <- function(x,y){
  K <- length(unique(y))# Nombre de groupes
  n <- length(x)# Nombre d’observations
  m <- mean(x)# Moyenne globale
  TSS <- sum((x-m)^2) # Variabilité totale
  nk <- table(y) # Effectifs conditionnels
  mk <- tapply(x,y,mean) # Moyennes conditionnelles
  BSS <- sum(nk * (mk - m)^2) # Variabilité expliquée
  result <- c(mk,100.0*BSS/TSS) # Moyennes + prop. variance expliquée
  names(result) <- c(paste("G",1 :K),"% epl.")# Nommer les élements du vecteur
  return(result) # Renvoyer le vecteur résultat
}

```

```{r}
# Créez une variable de regroupement en utilisant kmeans
set.seed(23)
res.km <- kmeans(var.v$coord, centers = 4, nstart = 25)# Créez 3 groupes de variables (centers = 3)
grp <- as.factor(res.km$cluster)
# Colorer les variables par groupes
fviz_pca_var(res.pca.v, col.var = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green"), legend.title = "Cluster") # colorer en fonction des clusters


# Créez une variable de regroupement en utilisant kmeans
set.seed(23)
res.km <- kmeans(var.gv$coord, centers = 4, nstart = 25)# Créez 3 groupes de variables (centers = 3)
grp <- as.factor(res.km$cluster)
# Colorer les variables par groupes
fviz_pca_var(res.pca.gv, col.var = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green"), legend.title = "Cluster") # colorer en fonction des clusters

# Créez une variable de regroupement en utilisant kmeans
set.seed(23)
res.km <- kmeans(var.ga$coord, centers = 4, nstart = 25)# Créez 3 groupes de variables (centers = 3)
grp <- as.factor(res.km$cluster)
# Colorer les variables par groupes
fviz_pca_var(res.pca.ga, col.var = grp, palette = c("#0073C2FF", "#EFC000FF", "#868686FF","#FC4E07", "green"), legend.title = "Cluster") # colorer en fonction des clusters
```
Pour les trois territoires : 
Gps Grésivaudan = Voironnais
un groupe densité pop, nb_maisons_rp_2020
un groupe taux / superficie foret (1/3 majoration)
Un groupe mediane niveau / part_maison / taux_dossier_hab / taux changement (2/3) / objectifs 2022 maison(1/3)
un groupe taux majoration / objectifs_2022_maison : Voironnais et Grésivaudan
Un groupe taux_changement : Grenoble Alpes




```{r}
PCAshiny(res.pca.v)
```

```{r}
PCAshiny(res.pca.gv)
```

```{r}
PCAshiny(res.pca.ga)
```

```{r}

```